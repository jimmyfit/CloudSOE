{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "policyDefinitionId": {
            "type": "string",
            "metadata": {
                "description": "The policy that this assignment is for."
            }
        },
        "automanageAccount": {
            "type": "String",
            "metadata": {
                "displayName": "Automanage account",
                "description": "Select Automanage account from dropdown list. If this account is outside of the scope of the assignment you must manually grant 'Contributor' permissions (or similar) on the account to the policy assignment's principal ID.",
                "strongType": "Microsoft.Automanage/accounts",
                "assignPermissions": true
            }
        },
        "assignmentName": {
            "type": "string",
            "metadata": {
                "description": "Name of the policyAssignment resource."
            }
        },
        "policyScopeId": {
            "type": "string",
            "metadata": {
                "description": "The scope at which policies, relating to the cloud SOE, will be assigned."
            }
        },
        "assignedBy": {
            "type": "string",
            "metadata": {
                "description": "Identifier for who is creating the assignment."
            }
        }
    },
    "resources": [
        {
            "type": "Microsoft.Authorization/policyAssignments",
            "name": "[parameters('assignmentName')]",
            "apiVersion": "2019-09-01",
            "location": "eastus",
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {
                "scope": "[parameters('policyScopeId')]",
                "policyDefinitionId": "[parameters('policyDefinitionId')]",
                "displayName": "Azure virtual machine best practices – Dev/test",
                "metadata": {
                    "assignedBy": "[parameters('assignedBy')]"
                },
                "parameters": {
                    "automanageAccount": {
                        "value": "[parameters('automanageAccount')]"
                    },
                    "configurationProfileAssignment": {
                        "value": "Azure virtual machine best practices – Dev/test"
                    },
                    "TagName": {
                        "value": "Production"
                    },
                    "TagValue": {
                        "value": "False"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Authorization/roleAssignments",
            "apiVersion": "2018-07-01",
            "name": "[guid(parameters('policyDefinitionId'), '1')]",
            "dependsOn": [
                "[resourceId('Microsoft.Authorization/policyAssignments', guid(parameters('policyDefinitionId'), '1'))]"
            ],
            "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                "principalId": "[reference(guid(parameters('policyDefinitionId'), '1'),'2019-09-01','Full').Identity.principalId]",
                "scope": "[parameters('policyScopeId')]"
            }
        }
    ]
}